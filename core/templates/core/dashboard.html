{% extends "base.html" %}

{% block title %}Inicio | La Termal ERP{% endblock %}
{% block page_title %}Inicio{% endblock %}
{% block page_subtitle %}Panorama general{% endblock %}

{% block content %}

{% if request.user.is_superuser or perms.auditoria.view_auditevent %}

<section class="ti-card p-4">
  <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
    <div class="min-w-0">
      <div class="text-xl font-semibold">Panorama de la empresa</div>
      <div class="text-sm ti-subtitle mt-1">Resumen del día para gerencia. Entrá a cada módulo para ver detalle.</div>
    </div>

    <div class="flex flex-wrap gap-2 items-center">
      {% if alert_crit_vtv or alert_crit_unidad or alert_crit_inv_sin_stock %}
        <span class="ti-badge-critical">Crítico</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}

      {% if inv_productos_bajo_min %}
        <span class="ti-badge-high">Atención: {{ inv_productos_bajo_min }}</span>
      {% else %}
        <span class="ti-badge-ok">Atención: 0</span>
      {% endif %}

      <span class="ti-badge-muted">Hoy: {{ today|date:"d/m/Y" }}</span>
    </div>
  </div>
</section>

<section class="ti-card p-4">
  <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
    <div class="min-w-0">
      <div class="text-lg font-semibold">Accesos directos</div>
      <div class="text-sm ti-subtitle mt-1">Entrar rápido a lo importante.</div>
    </div>

    <div class="flex flex-wrap gap-2">
      {% if perms.flota.view_colectivo %}
        <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Unidades</a>
      {% endif %}
      {% if perms.flota.view_salidaprogramada %}
        <a class="ti-btn" href="{% url 'flota:salida_list' %}">Horarios</a>
      {% endif %}
      {% if perms.flota.view_partediario %}
        <a class="ti-btn" href="{% url 'flota:parte_list' %}">Partes</a>
      {% endif %}
      {% if perms.inventario.view_producto %}
        <a class="ti-btn" href="{% url 'inventario:producto_list' %}">Inventario</a>
      {% endif %}
      {% if perms.inventario.view_movimientostock %}
        <a class="ti-btn" href="{% url 'inventario:movimiento_list' %}">Movimientos</a>
      {% endif %}
      <a class="ti-btn" href="{% url 'auditoria:audit_list' %}">Auditoría</a>
      {% if perms.flota.view_salidaprogramada %}
        <a class="ti-btn" href="{% url 'flota:tv_horarios' %}">TV Horarios</a>
      {% endif %}
      {% if perms.flota.view_partediario %}
        <a class="ti-btn" href="{% url 'flota:tv_taller' %}">TV Taller</a>
      {% endif %}
    </div>
  </div>
</section>

<section class="ti-card p-4">
  <div class="flex items-start justify-between gap-3">
    <div class="min-w-0">
      <div class="text-lg font-semibold">Notificaciones</div>
      <div class="text-sm ti-subtitle mt-1">Acá van a llegar avisos e informes (diario / semanal / mensual).</div>
    </div>
    <span class="ti-badge-muted">0 nuevas</span>
  </div>

  <div class="ti-card p-3 mt-3">
    <div class="font-semibold">Sin notificaciones por ahora</div>
    <div class="text-sm ti-subtitle mt-1">Cuando implementemos reportes y avisos, se van a mostrar acá.</div>
  </div>
</section>

<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">

  {% if perms.flota.view_colectivo %}
  <div class="ti-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-semibold">Flota</div>
        <div class="text-sm ti-subtitle mt-1">Activas / Taller / Baja</div>
      </div>
      {% if kpi_baja %}
        <span class="ti-badge-critical">Alerta</span>
      {% elif kpi_taller %}
        <span class="ti-badge-high">Atención</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}
    </div>

    <div class="grid grid-cols-3 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Activas</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_activos|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Taller</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_taller|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Baja</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_baja|default:0 }}</div>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Abrir flota</a>
      <a class="ti-btn" href="{% url 'flota:informe_flota' %}">Informe 30 días</a>
    </div>
  </div>
  {% endif %}

  {% if perms.flota.view_colectivo %}
  <div class="ti-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-semibold">Vencimientos VTV</div>
        <div class="text-sm ti-subtitle mt-1">Vencido / hoy / por vencer / pendiente</div>
      </div>
      {% if alert_crit_vtv %}
        <span class="ti-badge-critical">Crítico</span>
      {% elif kpi_vtv_por_vencer_7 or kpi_vtv_sin_fecha %}
        <span class="ti-badge-high">Atención</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}
    </div>

    <div class="grid grid-cols-2 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Vencido</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_vtv_vencidos|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Hoy</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_vtv_hoy|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Por vencer</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_vtv_por_vencer_7|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Pendiente</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_vtv_sin_fecha|default:0 }}</div>
      </div>

    <div class="mt-4 ti-card p-0 overflow-hidden">
      <div class="p-3 border-b border-slate-200 dark:border-slate-800">
        <div class="text-sm font-semibold">Detalle</div>
        <div class="text-xs ti-subtitle">Primeros 12 vencimientos ordenados por prioridad.</div>
      </div>

      <div class="overflow-x-auto">
        <table class="ti-table">
          <thead class="ti-thead">
            <tr class="ti-tr">
              <th class="ti-th">Interno</th>
              <th class="ti-th">Dominio</th>
              <th class="ti-th">VTV</th>
              <th class="ti-th">Estado</th>
              <th class="ti-th text-right">Días</th>
            </tr>
          </thead>
          <tbody>
            {% for r in vencimientos_vtv|slice:":12" %}
              <tr class="ti-tr">
                <td class="ti-td font-semibold tabular-nums">{{ r.interno }}</td>
                <td class="ti-td">{{ r.dominio|default:"—" }}</td>
                <td class="ti-td">{% if r.fecha %}{{ r.fecha|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                <td class="ti-td">
                  {% if r.badge == "critical" %}
                    <span class="ti-badge-critical">{{ r.estado }}</span>
                  {% elif r.badge == "high" %}
                    <span class="ti-badge-high">{{ r.estado }}</span>
                  {% elif r.badge == "ok" %}
                    <span class="ti-badge-ok">{{ r.estado }}</span>
                  {% else %}
                    <span class="ti-badge-muted">{{ r.estado }}</span>
                  {% endif %}
                </td>
                <td class="ti-td text-right tabular-nums">{% if r.dias is not None %}{{ r.dias }}{% else %}—{% endif %}</td>
              </tr>
            {% empty %}
              <tr class="ti-tr"><td class="ti-td" colspan="5">Sin datos.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Ver unidades</a>
    </div>
  </div>
  {% endif %}

  {% if perms.flota.view_salidaprogramada %}
  <div class="ti-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-semibold">Horarios (diagrama)</div>
        <div class="text-sm ti-subtitle mt-1">Total / especiales / sin chofer</div>
      </div>
      {% if kpi_salidas_hoy_sin_asignar %}
        <span class="ti-badge-high">Atención</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}
    </div>

    <div class="grid grid-cols-3 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Total</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_salidas_hoy_total|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Especial</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_salidas_hoy_especial|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Sin chofer</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_salidas_hoy_sin_asignar|default:0 }}</div>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:salida_list' %}">Abrir horarios</a>
      <a class="ti-btn" href="{% url 'flota:tv_horarios' %}">TV Horarios</a>
    </div>
  </div>
  {% endif %}

  {% if perms.flota.view_partediario %}
  <div class="ti-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-semibold">Taller (partes)</div>
        <div class="text-sm ti-subtitle mt-1">Abiertos / proceso / críticos</div>
      </div>
      {% if kpi_partes_criticos %}
        <span class="ti-badge-critical">Crítico</span>
      {% elif kpi_partes_abiertos or kpi_partes_en_proceso %}
        <span class="ti-badge-high">Atención</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}
    </div>

    <div class="grid grid-cols-3 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Abiertos</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_partes_abiertos|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Proceso</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_partes_en_proceso|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Críticos</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_partes_criticos|default:0 }}</div>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:parte_list' %}">Abrir partes</a>
      <a class="ti-btn" href="{% url 'flota:tv_taller' %}">TV Taller</a>
    </div>
  </div>
  {% endif %}

  {% if perms.inventario.view_producto or perms.inventario.view_movimientostock %}
  <div class="ti-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-semibold">Inventario</div>
        <div class="text-sm ti-subtitle mt-1">Con stock / bajo mínimo / sin stock</div>
      </div>
      {% if inv_productos_sin_stock %}
        <span class="ti-badge-critical">Crítico</span>
      {% elif inv_productos_bajo_min %}
        <span class="ti-badge-high">Atención</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}
    </div>

    <div class="grid grid-cols-3 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Con stock</div>
        <div class="text-2xl font-semibold tabular-nums">{{ inv_productos_con_stock|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Bajo mín.</div>
        <div class="text-2xl font-semibold tabular-nums">{{ inv_productos_bajo_min|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Sin stock</div>
        <div class="text-2xl font-semibold tabular-nums">{{ inv_productos_sin_stock|default:0 }}</div>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      {% if perms.inventario.view_producto %}
        <a class="ti-btn" href="{% url 'inventario:producto_list' %}">Productos</a>
      {% endif %}
      {% if perms.inventario.view_movimientostock %}
        <a class="ti-btn" href="{% url 'inventario:movimiento_list' %}">Movimientos</a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="ti-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-semibold">Auditoría</div>
        <div class="text-sm ti-subtitle mt-1">Actividad + errores + seguimiento</div>
      </div>
      {% if kpi_audit_hoy_err %}
        <span class="ti-badge-high">Atención</span>
      {% else %}
        <span class="ti-badge-ok">OK</span>
      {% endif %}
    </div>

    <div class="grid grid-cols-3 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Eventos hoy</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_audit_hoy_total|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Errores</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_audit_hoy_err|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Lentos</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_audit_hoy_slow|default:0 }}</div>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'auditoria:audit_list' %}">Abrir auditoría</a>
      <a class="ti-btn" href="{% url 'auditoria:audit_export_csv' %}">Exportar CSV</a>
    </div>
  </div>

</section>

<section class="ti-card p-4">
  <div class="text-lg font-semibold">Módulos planificados</div>
  <div class="text-sm ti-subtitle mt-1">Solo para tener el panorama de lo que viene.</div>

  <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3 mt-3">
    <div class="ti-card p-3"><div class="font-semibold">Reportes</div><div class="text-sm ti-subtitle mt-1">Diario / semanal</div></div>
    <div class="ti-card p-3"><div class="font-semibold">Compras</div><div class="text-sm ti-subtitle mt-1">Proveedores</div></div>
    <div class="ti-card p-3"><div class="font-semibold">Combustible</div><div class="text-sm ti-subtitle mt-1">Cargas</div></div>
    <div class="ti-card p-3"><div class="font-semibold">OT Taller</div><div class="text-sm ti-subtitle mt-1">Órdenes</div></div>
    <div class="ti-card p-3"><div class="font-semibold">Mantenimientos</div><div class="text-sm ti-subtitle mt-1">Preventivo</div></div>
    <div class="ti-card p-3"><div class="font-semibold">Gomería</div><div class="text-sm ti-subtitle mt-1">Neumáticos</div></div>
  </div>
</section>

{% elif perms.flota.add_partediario and perms.flota.view_salidaprogramada and not perms.inventario.view_producto and not perms.inventario.view_movimientostock and not perms.flota.view_colectivo and not perms.flota.view_partediario and not perms.auditoria.view_auditevent %}

<section class="ti-card p-4">
  <div class="text-xl font-semibold">Inicio (Chofer)</div>
  <div class="text-sm ti-subtitle mt-1">Vas a ver solo lo necesario: horarios y reporte de parte.</div>
</section>

<section class="ti-card p-4">
  <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
    <div class="min-w-0">
      <div class="text-lg font-semibold">Accesos directos</div>
      <div class="text-sm ti-subtitle mt-1">Acciones disponibles para chofer.</div>
    </div>
    <div class="flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:salida_list' %}">Horarios</a>
      <a class="ti-btn" href="{% url 'flota:chofer_parte_create' %}">Reportar parte</a>
      <a class="ti-btn" href="{% url 'flota:tv_horarios' %}">TV Horarios</a>
    </div>
  </div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-2 gap-4">

  <div class="ti-card p-4">
    <div class="text-lg font-semibold">Horarios</div>
    <div class="text-sm ti-subtitle mt-1">Solo lectura.</div>

    <div class="grid grid-cols-3 gap-2 mt-3">
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Total</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_salidas_hoy_total|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Especial</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_salidas_hoy_especial|default:0 }}</div>
      </div>
      <div class="ti-card p-3">
        <div class="text-sm ti-subtitle">Sin chofer</div>
        <div class="text-2xl font-semibold tabular-nums">{{ kpi_salidas_hoy_sin_asignar|default:0 }}</div>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:salida_list' %}">Abrir horarios</a>
      <a class="ti-btn" href="{% url 'flota:tv_horarios' %}">TV Horarios</a>
    </div>
  </div>

  <div class="ti-card p-4">
    <div class="text-lg font-semibold">Reportar parte</div>
    <div class="text-sm ti-subtitle mt-1">Informá problemas o fallas detectadas.</div>

    <div class="ti-card p-3 mt-3">
      <div class="font-semibold">Recomendación</div>
      <div class="text-sm ti-subtitle mt-1">Completá lo que sepas. Taller puede ampliar después.</div>
    </div>

    <div class="mt-3">
      <a class="ti-btn" href="{% url 'flota:chofer_parte_create' %}">Cargar parte</a>
    </div>
  </div>

</section>

{% else %}

<section class="ti-card p-4">
  <div class="text-xl font-semibold">Inicio</div>
  <div class="text-sm ti-subtitle mt-1">Resumen según permisos.</div>
</section>

<section class="ti-card p-4">
  <div class="text-lg font-semibold">Accesos directos</div>
  <div class="text-sm ti-subtitle mt-1">Se muestran solo los módulos habilitados.</div>

  <div class="flex flex-wrap gap-2 mt-3">
    {% if perms.flota.view_colectivo %}
      <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Unidades</a>
    {% endif %}
    {% if perms.flota.view_salidaprogramada %}
      <a class="ti-btn" href="{% url 'flota:salida_list' %}">Horarios</a>
    {% endif %}
    {% if perms.flota.view_partediario %}
      <a class="ti-btn" href="{% url 'flota:parte_list' %}">Partes</a>
    {% endif %}
    {% if perms.inventario.view_producto %}
      <a class="ti-btn" href="{% url 'inventario:producto_list' %}">Inventario</a>
    {% endif %}
    {% if perms.inventario.view_movimientostock %}
      <a class="ti-btn" href="{% url 'inventario:movimiento_list' %}">Movimientos</a>
    {% endif %}
    {% if perms.flota.view_salidaprogramada %}
      <a class="ti-btn" href="{% url 'flota:tv_horarios' %}">TV Horarios</a>
    {% endif %}
    {% if perms.flota.view_partediario %}
      <a class="ti-btn" href="{% url 'flota:tv_taller' %}">TV Taller</a>
    {% endif %}
  </div>
</section>

{% endif %}

{% endblock %}