{% extends "base.html" %}
{% load static %}

{% block title %}Inicio | La Termal ERP{% endblock %}
{% block page_title %}Inicio{% endblock %}
{% block page_subtitle %}Pantalla operativa: qué está crítico hoy y qué acciones seguir.{% endblock %}

{% block content %}
<div class="space-y-4">

  <!-- Header operativo + accesos rápidos -->
  <section class="ti-card p-4 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
    <div class="min-w-0">
      <div class="text-sm font-semibold">Inicio de turno</div>
      <div class="text-xs ti-subtitle truncate">
        Fecha: {{ today|date:"d/m/Y" }} · Ventana crítica: hoy y próximos 7 días · {{ header_status_text }}
      </div>
    </div>

    <div class="flex flex-wrap gap-2">
      {% url 'flota:salida_list' as url_horarios %}
      {% url 'flota:parte_list' as url_partes %}
      {% url 'inventario:movimiento_list' as url_movs %}
      {% url 'flota:colectivo_list' as url_unidades %}
      {% url 'flota:chofer_list' as url_choferes %}

      {% if url_horarios %}<a href="{{ url_horarios }}" class="ti-btn">Horarios</a>{% endif %}
      {% if url_partes %}<a href="{{ url_partes }}" class="ti-btn">Partes</a>{% endif %}
      {% if url_movs %}<a href="{{ url_movs }}" class="ti-btn">Inventario</a>{% endif %}
      {% if url_unidades %}<a href="{{ url_unidades }}" class="ti-btn">Unidades</a>{% endif %}
      {% if url_choferes %}<a href="{{ url_choferes }}" class="ti-btn">Choferes</a>{% endif %}
    </div>
  </section>

  <!-- KPIs (Inventario + Flota) -->
  <section class="grid grid-cols-1 xl:grid-cols-3 gap-3">

    <!-- INVENTARIO -->
    <div class="ti-card p-4">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-sm font-semibold">Inventario</div>
          <div class="text-xs ti-subtitle">Disponibilidad real (productos con stock &gt; 0)</div>
        </div>
        <span class="ti-badge-ok">Operativo</span>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between text-sm">
          <span>Disponibilidad</span>
          <span class="font-semibold tabular-nums">{{ inv_disponibilidad_pct }}%</span>
        </div>
        <div class="mt-2 h-2 rounded-full bg-slate-100 dark:bg-slate-900 overflow-hidden">
          <div class="h-2 bg-emerald-500" data-progress data-value="{{ inv_disponibilidad_pct }}"></div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Productos</div>
          <div class="font-semibold tabular-nums">{{ inv_total_productos }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Ubicaciones</div>
          <div class="font-semibold tabular-nums">{{ inv_total_ubicaciones }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Sin stock</div>
          <div class="font-semibold tabular-nums">{{ inv_productos_sin_stock }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Bajo mínimo</div>
          <div class="font-semibold tabular-nums">{{ inv_productos_bajo_min }}</div>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <a class="ti-btn" href="{% url 'inventario:stock_list' %}?low=1">Ver low stock</a>
        <a class="ti-btn" href="{% url 'inventario:movimiento_create' %}">Nuevo movimiento</a>
      </div>
    </div>

    <!-- MOVIMIENTOS -->
    <div class="ti-card p-4">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-sm font-semibold">Pañol hoy</div>
          <div class="text-xs ti-subtitle">Movimientos reales (hoy y últimos 7 días)</div>
        </div>
        <span class="ti-badge-info">Hoy</span>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Mov. hoy</div>
          <div class="font-semibold tabular-nums">{{ inv_mov_hoy }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Mov. 7 días</div>
          <div class="font-semibold tabular-nums">{{ inv_mov_7 }}</div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Ingresos</div>
          <div class="font-semibold tabular-nums">{{ inv_mov_hoy_ing }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Egresos</div>
          <div class="font-semibold tabular-nums">{{ inv_mov_hoy_egr }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Ajustes</div>
          <div class="font-semibold tabular-nums">{{ inv_mov_hoy_ajs }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Transfer.</div>
          <div class="font-semibold tabular-nums">{{ inv_mov_hoy_trf }}</div>
        </div>
      </div>

      <div class="mt-3">
        <a class="ti-btn" href="{% url 'inventario:movimiento_list' %}">Ver movimientos</a>
      </div>
    </div>

    <!-- FLOTA / VTV -->
    <div class="ti-card p-4">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-sm font-semibold">Flota</div>
          <div class="text-xs ti-subtitle">Operativo + VTV (real)</div>
        </div>
        <span class="ti-badge-ok">Operativa</span>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between text-sm">
          <span>Operativo</span>
          <span class="font-semibold tabular-nums">{{ kpi_flota_operativo_pct }}%</span>
        </div>
        <div class="mt-2 h-2 rounded-full bg-slate-100 dark:bg-slate-900 overflow-hidden">
          <div class="h-2 bg-emerald-500" data-progress data-value="{{ kpi_flota_operativo_pct }}"></div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Activos</div>
          <div class="font-semibold tabular-nums">{{ kpi_activos }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Taller</div>
          <div class="font-semibold tabular-nums">{{ kpi_taller }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Baja</div>
          <div class="font-semibold tabular-nums">{{ kpi_baja }}</div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">VTV venc./hoy</div>
          <div class="font-semibold tabular-nums">{{ kpi_vtv_vencidos|add:kpi_vtv_hoy }}</div>
        </div>
        <div class="ti-card p-3">
          <div class="text-xs ti-subtitle">Por vencer (7d)</div>
          <div class="font-semibold tabular-nums">{{ kpi_vtv_por_vencer_7 }}</div>
        </div>
      </div>

      <div class="mt-3">
        <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Ver flota</a>
      </div>
    </div>

  </section>
    <!-- Unidades (acceso rápido a informe 30 días) -->
  <section class="ti-card p-4">
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-sm font-semibold">Unidades</div>
        <div class="text-xs ti-subtitle">Acceso rápido al informe por unidad (últimos 30 días)</div>
      </div>
      <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Ver flota</a>
    </div>

    <div class="mt-3 overflow-x-auto">
      <table class="ti-table">
        <thead class="ti-thead">
          <tr>
            <th class="ti-th">Interno</th>
            <th class="ti-th">Dominio</th>
            <th class="ti-th">Estado</th>
            <th class="ti-th">VTV</th>
            <th class="ti-th text-right">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for u in colectivos_quick %}
            <tr class="ti-tr">
              <td class="ti-td font-semibold tabular-nums">{{ u.interno }}</td>
              <td class="ti-td">{{ u.dominio|default:"—" }}</td>
              <td class="ti-td">
                {% if u.estado == "ACTIVO" %}
                  <span class="ti-badge-ok">Activa</span>
                {% elif u.estado == "TALLER" %}
                  <span class="ti-badge-high">Taller</span>
                {% elif u.estado == "BAJA" %}
                  <span class="ti-badge-critical">Baja</span>
                {% else %}
                  <span class="ti-badge-muted">{{ u.estado }}</span>
                {% endif %}
              </td>
              <td class="ti-td">
                {% if u.revision_tecnica_vto %}
                  {{ u.revision_tecnica_vto|date:"d/m/Y" }}
                {% else %}
                  <span class="ti-badge-info">Sin fecha</span>
                {% endif %}
              </td>
              <td class="ti-td text-right">
                <a class="ti-btn" href="{% url 'flota:colectivo_report' u.pk %}">Informe 30 días</a>
              </td>
            </tr>
          {% empty %}
            <tr class="ti-tr"><td class="ti-td" colspan="5"><div class="text-xs ti-subtitle">No hay unidades.</div></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Operación: críticos inventario + movimientos recientes -->
  <section class="grid grid-cols-1 2xl:grid-cols-2 gap-3">

    <!-- Críticos inventario -->
    <div class="ti-card p-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">Críticos de inventario</div>
          <div class="text-xs ti-subtitle">Sin stock o por debajo del mínimo (real)</div>
        </div>
        <a class="ti-btn" href="{% url 'inventario:stock_list' %}?low=1">Low stock</a>
      </div>

      <div class="mt-3 overflow-x-auto">
        <table class="ti-table">
          <thead class="ti-thead">
            <tr>
              <th class="ti-th">Producto</th>
              <th class="ti-th">Ubicaciones</th>
              <th class="ti-th text-right">Stock</th>
              <th class="ti-th text-right">Mín.</th>
              <th class="ti-th">Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for it in criticos_inventario %}
              <tr class="ti-tr">
                <td class="ti-td">
                  <div class="font-semibold">{{ it.codigo }}</div>
                  <div class="text-xs ti-subtitle truncate">{{ it.nombre }}</div>
                </td>
                <td class="ti-td text-slate-600 dark:text-slate-300">{{ it.ubicaciones }}</td>
                <td class="ti-td text-right tabular-nums">{{ it.stock_total }}</td>
                <td class="ti-td text-right tabular-nums">{{ it.stock_minimo }}</td>
                <td class="ti-td">
                  {% if it.badge == "critical" %}
                    <span class="ti-badge-critical">{{ it.estado }}</span>
                  {% else %}
                    <span class="ti-badge-high">{{ it.estado }}</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr class="ti-tr">
                <td class="ti-td" colspan="5"><div class="text-xs ti-subtitle">No hay críticos (bien).</div></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Movimientos recientes -->
    <div class="ti-card p-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">Movimientos recientes</div>
          <div class="text-xs ti-subtitle">Últimos registros (real)</div>
        </div>
        <a class="ti-btn" href="{% url 'inventario:movimiento_list' %}">Ver todos</a>
      </div>

      <div class="mt-3 overflow-x-auto">
        <table class="ti-table">
          <thead class="ti-thead">
            <tr>
              <th class="ti-th">Fecha</th>
              <th class="ti-th">Tipo</th>
              <th class="ti-th">Producto</th>
              <th class="ti-th">Origen</th>
              <th class="ti-th">Destino</th>
              <th class="ti-th text-right">Cantidad</th>
            </tr>
          </thead>
          <tbody>
            {% for m in movimientos_recientes %}
              <tr class="ti-tr">
                <td class="ti-td text-xs tabular-nums">{{ m.fecha|date:"d/m H:i" }}</td>
                <td class="ti-td">
                  {% if m.tipo == "EGRESO" %}
                    <span class="ti-badge-high">Egreso</span>
                  {% elif m.tipo == "INGRESO" %}
                    <span class="ti-badge-ok">Ingreso</span>
                  {% elif m.tipo == "AJUSTE" %}
                    <span class="ti-badge-info">Ajuste</span>
                  {% else %}
                    <span class="ti-badge-muted">Transfer.</span>
                  {% endif %}
                </td>
                <td class="ti-td">
                  <div class="font-semibold">{{ m.producto.codigo }}</div>
                  <div class="text-xs ti-subtitle truncate">{{ m.producto.nombre }}</div>
                </td>
                <td class="ti-td tabular-nums">{{ m.ubicacion.codigo }}</td>
                <td class="ti-td tabular-nums">
                  {% if m.ubicacion_destino %}{{ m.ubicacion_destino.codigo }}{% else %}—{% endif %}
                </td>
                <td class="ti-td text-right tabular-nums">{{ m.cantidad }}</td>
              </tr>
            {% empty %}
              <tr class="ti-tr">
                <td class="ti-td" colspan="6"><div class="text-xs ti-subtitle">Sin movimientos.</div></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- Vencimientos VTV -->
  <section class="ti-card p-4" id="vencimientos">
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-sm font-semibold">Vencimientos VTV</div>
        <div class="text-xs ti-subtitle">Vencido/Hoy = crítico · 1-7 días = alta · sin fecha = pendiente</div>
      </div>
      <a class="ti-btn" href="{% url 'flota:colectivo_list' %}">Ver flota</a>
    </div>

    <div class="mt-3 overflow-x-auto">
      <table class="ti-table">
        <thead class="ti-thead">
          <tr>
            <th class="ti-th">Interno</th>
            <th class="ti-th">Dominio</th>
            <th class="ti-th">Fecha</th>
            <th class="ti-th text-right">Días</th>
            <th class="ti-th">Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for row in vencimientos_vtv %}
            <tr class="ti-tr">
              <td class="ti-td font-semibold tabular-nums">{{ row.interno }}</td>
              <td class="ti-td">{{ row.dominio|default:"—" }}</td>
              <td class="ti-td">{% if row.fecha %}{{ row.fecha|date:"d/m/Y" }}{% else %}—{% endif %}</td>
              <td class="ti-td text-right tabular-nums">{% if row.dias is not None %}{{ row.dias }}{% else %}—{% endif %}</td>
              <td class="ti-td">
                {% if row.badge == "critical" %}
                  <span class="ti-badge-critical">{{ row.estado }}</span>
                {% elif row.badge == "high" %}
                  <span class="ti-badge-high">{{ row.estado }}</span>
                {% elif row.badge == "ok" %}
                  <span class="ti-badge-ok">{{ row.estado }}</span>
                {% else %}
                  <span class="ti-badge-muted">{{ row.estado }}</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr class="ti-tr"><td class="ti-td" colspan="5"><div class="text-xs ti-subtitle">Sin datos.</div></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pages/dashboard.js' %}" defer></script>
{% endblock %}