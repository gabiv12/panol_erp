{% extends "base.html" %}
{% load static %}

{% block title %}Movimiento | Inventario{% endblock %}
{% block page_title %}Movimiento{% endblock %}
{% block page_subtitle %}Registrar ingreso, egreso, ajuste o transferencia{% endblock %}

{% block content %}

<div class="space-y-4">

  {% include "inventario/_nav.html" with active_tab="movimientos" %}
  

  <section class="ti-card p-4">
    <form method="post" class="space-y-4" novalidate data-stock-url="{% url 'inventario:api_stock_por_ubicacion' %}">

{% csrf_token %}

{% if next %}
  <input type="hidden" name="next" value="{{ next }}">
{% endif %}

{% if form.errors %}
  <div class="ti-card p-3">
    <div class="text-sm font-semibold">No se pudo guardar</div>
    <div class="text-xs ti-subtitle mt-1">Revisá los campos marcados. Para egreso, verificá stock disponible. Para transferencia, elegí destino.</div>
  </div>
{% endif %}

{% if form.non_field_errors %}
  <div class="ti-alert ti-alert-danger">{{ form.non_field_errors }}</div>
{% endif %}

<div class="sticky top-0 z-20 -mx-4 -mt-4 px-4 py-3 bg-white/90 dark:bg-slate-950/90 backdrop-blur border-b border-slate-200 dark:border-slate-800 rounded-t-2xl">
  <div class="flex items-center justify-between gap-3">
    <div class="min-w-0">
      <div class="text-sm font-semibold">Movimiento</div>
      <div class="text-xs ti-subtitle">Producto → Acción → Detalles</div>
    </div>
    <div class="flex items-center gap-2 shrink-0">
      <a class="ti-btn" href="{% url 'inventario:movimiento_list' %}">Cancelar</a>
      <button class="ti-btn-primary" type="submit">Guardar</button>
    </div>
  </div>
</div>

<div class="ti-card p-4">
  <div class="flex items-start justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Qué</div>
      <div class="text-xs ti-subtitle">Elegí el producto. Podés buscar o usar recientes.</div>
    </div>
    <span class="ti-badge-muted">1/3</span>
  </div>

  <div class="mt-3">
    <label class="text-xs ti-subtitle">Buscar producto</label>
    <input id="producto_search" type="search" class="ti-input w-full" placeholder="Escribí para filtrar la lista…" autocomplete="off" />
    <div id="producto_recientes" class="mt-2 flex flex-wrap gap-2"></div>
  </div>

  <div class="mt-3">
    <label class="text-xs ti-subtitle">Producto <span class="text-red-500">*</span></label>
    {{ form.producto }}
    <div id="err_producto" class="hidden mt-1 text-xs text-red-500">Elegí un producto.</div>
    {% if form.producto.errors %}<div class="ti-field-error">{{ form.producto.errors }}</div>{% endif %}
    <div class="mt-2 text-xs ti-subtitle" id="producto_hint">Stock actual: — · Último movimiento: —</div>
  </div>
</div>

<div class="ti-card p-4">
  <div class="flex items-start justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Acción</div>
      <div class="text-xs ti-subtitle">Elegí qué vas a registrar.</div>
    </div>
    <span class="ti-badge-muted">2/3</span>
  </div>

  <div class="mt-3 flex flex-wrap gap-2" id="tipo_pills">
    <button type="button" class="ti-btn px-4 py-2" data-tipo="INGRESO">Entrada</button>
    <button type="button" class="ti-btn px-4 py-2" data-tipo="EGRESO">Salida</button>
    <button type="button" class="ti-btn px-4 py-2" data-tipo="AJUSTE">Ajuste</button>
    <button type="button" class="ti-btn px-4 py-2" data-tipo="TRANSFERENCIA">Transferencia</button>
  </div>

  <div id="err_tipo" class="hidden mt-2 text-xs text-red-500">Elegí una acción.</div>

  <div class="hidden">
    {{ form.tipo }}
  </div>

  {% if form.tipo.errors %}<div class="ti-field-error">{{ form.tipo.errors }}</div>{% endif %}

  <div class="mt-3 text-xs ti-subtitle" id="tipo_hint">Elegí una acción para que el formulario se acomode.</div>
</div>

<div class="ti-card p-4 space-y-4">
  <div class="flex items-start justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Dónde y cuánto</div>
      <div class="text-xs ti-subtitle">Ubicación, cantidad y referencia.</div>
    </div>
    <span class="ti-badge-muted">3/3</span>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="text-xs ti-subtitle">Ubicación origen <span class="text-red-500">*</span></label>
      {{ form.ubicacion }}
      <div id="err_origen" class="hidden mt-1 text-xs text-red-500">Elegí una ubicación.</div>
      {% if form.ubicacion.errors %}<div class="ti-field-error">{{ form.ubicacion.errors }}</div>{% endif %}
      <div class="mt-1 text-xs ti-subtitle">De dónde sale / dónde entra.</div>
    </div>

    <div id="destino_wrap" class="hidden">
      <label class="text-xs ti-subtitle">Ubicación destino <span class="text-red-500">*</span></label>
      {{ form.ubicacion_destino }}
      <div id="err_destino" class="hidden mt-1 text-xs text-red-500">Para transferencia, elegí destino.</div>
      {% if form.ubicacion_destino.errors %}<div class="ti-field-error">{{ form.ubicacion_destino.errors }}</div>{% endif %}
      <div class="mt-1 text-xs ti-subtitle">A dónde se mueve.</div>
    </div>

    <div>
      <label class="text-xs ti-subtitle">Cantidad <span class="text-red-500">*</span></label>
      {{ form.cantidad }}
      <div id="err_cantidad" class="hidden mt-1 text-xs text-red-500">Cantidad debe ser mayor a 0.</div>
      {% if form.cantidad.errors %}<div class="ti-field-error">{{ form.cantidad.errors }}</div>{% endif %}
      <div class="mt-1 text-xs ti-subtitle">Ej: 2</div>
    </div>

    <div>
      <label class="text-xs ti-subtitle">Interno (opcional)</label>
      {{ form.colectivo }}
      {% if form.colectivo.errors %}<div class="ti-field-error">{{ form.colectivo.errors }}</div>{% endif %}
      <div class="mt-1 text-xs ti-subtitle">Si se usó en una unidad, cargalo.</div>
    </div>

    <div class="md:col-span-2">
      <label class="text-xs ti-subtitle">Referencia (opcional)</label>
      {{ form.referencia }}
      {% if form.referencia.errors %}<div class="ti-field-error">{{ form.referencia.errors }}</div>{% endif %}
      <div class="mt-1 text-xs ti-subtitle">Parte/OT/Nota. Ej: PD-153 / OT-22</div>
    </div>
  <div class="md:col-span-2 ti-card p-3">
    <div class="flex flex-wrap items-center gap-2">
      <span id="stock_actual_badge" class="ti-badge-muted">Stock: —</span>
      <span id="stock_quedara_badge" class="ti-badge-muted">Quedará: —</span>
      <span id="stock_msg" class="text-xs ti-subtitle"></span>
    </div>
    <div id="err_stock" class="hidden mt-1 text-xs text-red-500">No alcanza el stock en esa ubicación.</div>
  </div>

  </div>

  <details class="ti-card p-3" id="detalles_repuesto">
    <summary class="cursor-pointer text-sm font-semibold">Datos del repuesto (opcional)</summary>
    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div id="proveedor_wrap">
        <label class="text-xs ti-subtitle">Proveedor</label>
        {{ form.proveedor }}
        {% if form.proveedor.errors %}<div class="ti-field-error">{{ form.proveedor.errors }}</div>{% endif %}
      </div>

      <div id="lote_wrap">
        <label class="text-xs ti-subtitle">Lote</label>
        {{ form.lote }}
        {% if form.lote.errors %}<div class="ti-field-error">{{ form.lote.errors }}</div>{% endif %}
      </div>

      <div id="venc_wrap">
        <label class="text-xs ti-subtitle">Vencimiento</label>
        {{ form.fecha_vencimiento }}
        {% if form.fecha_vencimiento.errors %}<div class="ti-field-error">{{ form.fecha_vencimiento.errors }}</div>{% endif %}
      </div>
    </div>
  </details>

  <div id="observ_wrap">
    <label class="text-xs ti-subtitle">Observaciones (opcional)</label>
    {{ form.observaciones }}
    {% if form.observaciones.errors %}<div class="ti-field-error">{{ form.observaciones.errors }}</div>{% endif %}
  </div>

</div>
    </form>
  </section>
  

</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'inventario/js/movimientos.js' %}" defer></script>
{% endblock %}