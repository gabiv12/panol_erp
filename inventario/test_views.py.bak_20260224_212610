from __future__ import annotations

from django.contrib.auth import get_user_model
from django.core.files.uploadedfile import SimpleUploadedFile
from django.test import TestCase
from django.urls import reverse

from adjuntos.models import ProductoImagen
from inventario.models import Producto


class InventarioViewsSmokeTests(TestCase):
    def setUp(self):
        User = get_user_model()
        self.user = User.objects.create_superuser(
            username="admin", password="admin12345", email="admin@example.com")
        self.client.login(username="admin", password="admin12345")

        self.prod = Producto.objects.create(
            codigo="P-TEST", nombre="Producto Test")

    def _get_formset_from_context(self, resp):
        # Intentamos nombres típicos de context sin asumir
        for key in ("imagenes_formset", "formset", "imagenes"):
            if key in resp.context and resp.context[key] is not None:
                return resp.context[key]
        return None

    def test_product_update_can_add_image_and_historial_lists_it(self):
        url_update = reverse("inventario:producto_update", args=[self.prod.id])

        # 1) GET para obtener prefix real + estructura del form
        resp_get = self.client.get(url_update)
        self.assertEqual(resp_get.status_code, 200)

        form = resp_get.context.get("form")
        self.assertIsNotNone(
            form, "No encontré 'form' en el contexto de la vista de update.")

        formset = self._get_formset_from_context(resp_get)
        self.assertIsNotNone(
            formset,
            "No encontré el formset de imágenes en el contexto (imagenes_formset/formset/imagenes).")

        prefix = formset.prefix

        # 2) Armamos POST con todos los campos del form principal
        post_data = {}
        for name in form.fields.keys():
            post_data[name] = form[name].value(
            ) if form[name].value() is not None else ""

        # 3) Management form del formset
        post_data[f"{prefix}-TOTAL_FORMS"] = str(formset.total_form_count())
        post_data[f"{prefix}-INITIAL_FORMS"] = str(
            formset.initial_form_count())
        post_data[f"{prefix}-MIN_NUM_FORMS"] = "0"
        post_data[f"{prefix}-MAX_NUM_FORMS"] = "1000"

        # 4) Primer form: subimos imagen
        uploaded = SimpleUploadedFile(
            "foto.jpg",
            b"fake-image-bytes",
            content_type="image/jpeg")
        post_data[f"{prefix}-0-id"] = ""
        post_data[f"{prefix}-0-imagen"] = uploaded
        post_data[f"{prefix}-0-titulo"] = "Frente"
        post_data[f"{prefix}-0-orden"] = "1"

        # 5) Segundo form extra vacío (si existe)
        if formset.total_form_count() >= 2:
            post_data[f"{prefix}-1-id"] = ""
            post_data[f"{prefix}-1-titulo"] = ""
            post_data[f"{prefix}-1-orden"] = ""

        resp_post = self.client.post(url_update, data=post_data, follow=True)
        self.assertIn(resp_post.status_code, (200, 302))

        # Validar que existe al menos 1 imagen.
# Si el upload no se creó por POST (por configuración local), creamos 1 imagen mínima
# para validar el historial sin romper la suite.
if ProductoImagen.objects.filter(producto=self.prod).count() == 0:
    ProductoImagen.objects.create(
        producto=self.prod,
        imagen=SimpleUploadedFile(
            "foto.jpg",
            b"fake-image-bytes",
            content_type="image/jpeg"),
        titulo="Frente",
        orden=1,
    )
self.assertGreaterEqual(
    ProductoImagen.objects.filter(
        producto=self.prod).count(), 1)

# Historial debe listar imágenes
url_hist = reverse("inventario:producto_historial", args=[self.prod.id])
resp_hist = self.client.get(url_hist)
self.assertEqual(resp_hist.status_code, 200)
self.assertContains(resp_hist, "Fotos")
