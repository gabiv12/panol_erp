{% extends "base.html" %}

{% block title %}Horarios | La Termal ERP{% endblock %}
{% block page_title %}Horarios{% endblock %}
{% block page_subtitle %}Salidas programadas y viajes especiales{% endblock %}

{% block content %}

<div class="ti-card p-4 space-y-4">

  {% url 'flota:salida_add' as url_add %}
  {% url 'flota:salida_diagrama_edit' as url_diagrama_edit %}
  {% url 'flota:salida_dual' as url_dual %}
  {% url 'flota:tv_horarios' as url_tv %}
  {% url 'flota:salida_copy_prev_day' as url_copy_prev %}
  {% url 'flota:salida_print' as url_print %}

  <!-- Filtros (GET) -->
  <form method="get" class="space-y-3" id="salidasFilterForm">
    <div>
      <label class="ti-label">Buscar</label>
      <input class="ti-field" name="q" value="{{ q|default:'' }}" placeholder="Unidad, chofer, recorrido..." />
    </div>

    <div>
      <label class="ti-label">Fecha</label>
      <div class="flex flex-col sm:flex-row gap-2">
        <input type="date" class="ti-field" id="salidasFecha" name="fecha" value="{{ fecha }}" />

        <button type="submit" class="ti-btn-primary">Filtrar</button>
        <button type="button" class="ti-btn" data-set-date="today">Hoy</button>
        <button type="button" class="ti-btn" data-set-date="tomorrow">Mañana</button>
      </div>
      <p class="ti-help">Consejo: filtrá por interno, chofer o recorrido.</p>
    </div>
  </form>

  <!-- Acciones -->
  <div class="flex flex-wrap gap-2 pt-2">
    <a href="{{ url_add }}?fecha={{ fecha }}" class="ti-btn-primary">Nueva salida</a>
    <a href="{{ url_print }}?fecha={{ fecha }}" class="ti-btn">Imprimir</a>
    <a href="{{ url_diagrama_edit }}?fecha={{ fecha }}" class="ti-btn">Editar diagrama</a>
    <a href="{{ url_tv }}?fecha={{ fecha }}" class="ti-btn">Pantalla TV</a>
    <a href="{{ url_dual }}?fecha={{ fecha }}" class="ti-btn">Hoy + mañana</a>

    <form method="post" action="{{ url_copy_prev }}" class="inline" data-ti-confirm-form>
      {% csrf_token %}
      <input type="hidden" name="fecha" value="{{ fecha }}" />
      <button type="button" class="ti-btn" data-ti-confirm-open
              data-ti-title="Copiar día anterior"
              data-ti-body="¿Copiar todas las salidas del día anterior a esta fecha? Si ya existen algunas, se omiten duplicados.">
        Copiar día anterior
      </button>
    </form>
  </div>

</div>

<div class="ti-card mt-4 overflow-hidden">
  <table class="ti-table">
    <thead class="ti-thead">
      <tr>
        <th class="ti-th">Hora</th>
        <th class="ti-th">Unidad</th>
        <th class="ti-th">Tipo</th>
        <th class="ti-th">Estado</th>
        <th class="ti-th">Sección / Etiqueta</th>
        <th class="ti-th">Regreso</th>
        <th class="ti-th">Chofer</th>
        <th class="ti-th">Recorrido</th>
        <th class="ti-th text-right">Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for s in salidas %}
        <tr class="ti-tr {% if s.tipo == 'ESPECIAL' %}bg-amber-50/60 dark:bg-amber-950/20{% endif %}">
          <td class="ti-td font-semibold tabular-nums">{{ s.salida_programada|date:"H:i" }}</td>
          <td class="ti-td">
            <div class="font-semibold">Interno {{ s.colectivo.interno }}</div>
            <div class="ti-subtitle">{{ s.colectivo.dominio }}</div>
          </td>
          <td class="ti-td">{{ s.get_tipo_display }}</td>
          <td class="ti-td">{{ s.get_estado_display }}</td>
          <td class="ti-td">
            <div class="font-semibold">{{ s.seccion }}</div>
            <div class="ti-subtitle">{{ s.salida_label }}</div>
          </td>
          <td class="ti-td">{{ s.regreso|default:"—" }}</td>
          <td class="ti-td">{{ s.chofer|default:"—" }}</td>
          <td class="ti-td">{{ s.recorrido|default:"—" }}</td>
          <td class="ti-td text-right">
            <a href="{% url 'flota:salida_update' s.pk %}?fecha={{ fecha }}" class="ti-btn">Editar</a>
            <a href="{% url 'flota:salida_delete' s.pk %}?fecha={{ fecha }}" class="ti-btn-danger">Eliminar</a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="9" class="ti-td text-center ti-subtitle py-10">
            No hay salidas para esa fecha. Si recién empezás, primero cargá Unidades/Choferes y luego corré el seed de horarios fijos.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal interno: reemplazo de confirm() del navegador -->
<div id="tiConfirmOverlay" class="fixed inset-0 z-[60] hidden bg-slate-900/50"></div>
<div id="tiConfirmModal" class="fixed inset-0 z-[61] hidden items-center justify-center p-4">
  <div class="ti-card w-full max-w-lg p-4">
    <div class="text-base font-semibold" id="tiConfirmTitle">Confirmar</div>
    <div class="ti-subtitle mt-2" id="tiConfirmBody">—</div>

    <div class="mt-4 flex justify-end gap-2">
      <button type="button" class="ti-btn" id="tiConfirmCancel">Cancelar</button>
      <button type="button" class="ti-btn-primary" id="tiConfirmOk">Aceptar</button>
    </div>
  </div>
</div>

<script>
(function(){
  // Hoy / Mañana (sin romper el formato del input type=date)
  var fechaInput = document.getElementById('salidasFecha');
  var form = document.getElementById('salidasFilterForm');

  function pad(n){ return String(n).padStart(2,'0'); }
  function toISO(d){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }

  document.addEventListener('click', function(e){
    var btn = e.target.closest && e.target.closest('[data-set-date]');
    if (!btn || !fechaInput || !form) return;
    e.preventDefault();
    var v = btn.getAttribute('data-set-date');
    var d = new Date();
    if (v === 'tomorrow') d.setDate(d.getDate() + 1);
    fechaInput.value = toISO(d);
    form.submit();
  });

  // Confirm interno (copiar día anterior)
  var overlay = document.getElementById('tiConfirmOverlay');
  var modal = document.getElementById('tiConfirmModal');
  var titleEl = document.getElementById('tiConfirmTitle');
  var bodyEl = document.getElementById('tiConfirmBody');
  var btnOk = document.getElementById('tiConfirmOk');
  var btnCancel = document.getElementById('tiConfirmCancel');
  var pendingForm = null;

  function openModal(title, body, formEl){
    pendingForm = formEl;
    titleEl.textContent = title || 'Confirmar';
    bodyEl.textContent = body || '¿Continuar?';
    overlay.classList.remove('hidden');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeModal(){
    pendingForm = null;
    overlay.classList.add('hidden');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  document.addEventListener('click', function(e){
    var btn = e.target.closest && e.target.closest('[data-ti-confirm-open]');
    if (!btn) return;
    e.preventDefault();
    var f = btn.closest('form');
    if (!f) return;
    openModal(btn.getAttribute('data-ti-title'), btn.getAttribute('data-ti-body'), f);
  });

  btnCancel.addEventListener('click', function(){ closeModal(); });
  overlay.addEventListener('click', function(){ closeModal(); });
  btnOk.addEventListener('click', function(){
    if (pendingForm) pendingForm.submit();
    closeModal();
  });
})();
</script>

{% endblock %}
