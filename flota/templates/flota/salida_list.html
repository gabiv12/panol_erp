{% extends "base.html" %}
{% load static %}

{% block title %}Horarios | Flota{% endblock %}
{% block page_title %}Horarios{% endblock %}
{% block page_subtitle %}Salidas programadas y viajes especiales{% endblock %}

{% block content %}

<section class="ti-card p-4 space-y-4">

  <form method="get" class="space-y-3">
    <div>
      <label class="text-xs ti-subtitle">Buscar</label>
      <input name="q" value="{{ q }}" class="ti-input w-full" placeholder="Unidad, chofer, recorrido..." />
    </div>

    <div>
      <label class="text-xs ti-subtitle">Fecha</label>
      <input type="date" name="fecha" value="{{ fecha }}" class="ti-input w-full" />
      <div class="mt-2 flex flex-wrap gap-2">
        <button type="button" class="ti-btn" data-set-date="today">Hoy</button>
        <button type="button" class="ti-btn" data-set-date="tomorrow">Mañana</button>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <button class="ti-btn-primary" type="submit">Filtrar</button>

      <a class="ti-btn" href="{% url 'flota:salida_create' %}?fecha={{ fecha|urlencode }}">Nueva salida</a>

      <a class="ti-btn" href="{% url 'flota:salida_diagrama_print' %}?fecha={{ fecha|urlencode }}" target="_blank" rel="noopener">Imprimir</a>
          <a class="ti-btn" href="{% url 'flota:salida_diagrama_edit' %}?fecha={{ fecha|date:'Y-m-d'|urlencode }}">Editar diagrama</a>

      <a class="ti-btn" href="{% url 'flota:tv_horarios' %}" target="_blank" rel="noopener">Pantalla TV</a>

      <a class="ti-btn" href="{% url 'flota:salida_dual' %}?fecha={{ fecha|urlencode }}">Hoy + mañana</a>

      <form method="post" action="{% url 'flota:salida_copy_prev_day' %}" class="inline">
        {% csrf_token %}
        <input type="hidden" name="fecha" value="{{ fecha }}">
        <button type="submit" class="ti-btn" id="btnCopyPrevDay">Copiar día anterior</button>
      </form>
    </div>
  </form>

  <div class="ti-card p-0 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left">
            <th class="px-3 py-2">Hora</th>
            <th class="px-3 py-2">Unidad</th>
            <th class="px-3 py-2">Tipo</th>
            <th class="px-3 py-2">Estado</th>
            <th class="px-3 py-2">Sección / Etiqueta</th>
            <th class="px-3 py-2">Regreso</th>
            <th class="px-3 py-2">Chofer</th>
            <th class="px-3 py-2">Recorrido</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody>
          {% for s in salidas %}
            <tr class="border-t border-slate-200 dark:border-slate-800">
              <td class="px-3 py-2 whitespace-nowrap">{{ s.salida_programada|date:"H:i" }}</td>
              <td class="px-3 py-2 whitespace-nowrap">
                <div class="font-semibold">Interno {{ s.colectivo.interno }}</div>
                <div class="text-xs ti-subtitle">{{ s.colectivo.dominio }}</div>
              </td>
              <td class="px-3 py-2">{{ s.get_tipo_display }}</td>
              <td class="px-3 py-2">{{ s.get_estado_display }}</td>
              <td class="px-3 py-2">
                <div class="text-xs ti-subtitle">{{ s.seccion }}</div>
                <div class="font-semibold">{{ s.salida_label }}</div>
              </td>
              <td class="px-3 py-2">{{ s.regreso }}</td>
              <td class="px-3 py-2">{{ s.chofer }}</td>
              <td class="px-3 py-2">{{ s.recorrido }}</td>
              <td class="px-3 py-2 text-right whitespace-nowrap">
                <a class="ti-btn" href="{% url 'flota:salida_update' s.id %}?fecha={{ fecha|urlencode }}">Editar</a>
                <a class="ti-btn" href="{% url 'flota:salida_delete' s.id %}?fecha={{ fecha|urlencode }}">Eliminar</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-3 py-6 text-center ti-subtitle" colspan="9">No hay salidas para esa fecha.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</section>

<script>
  (function() {
    const btns = document.querySelectorAll("[data-set-date]");
    const dateInput = document.querySelector('input[name="fecha"]');
    if (!dateInput) return;

    function fmt(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }

    btns.forEach(b => {
      b.addEventListener("click", () => {
        const now = new Date();
        if (b.dataset.setDate === "tomorrow") now.setDate(now.getDate() + 1);
        dateInput.value = fmt(now);
      });
    });

    const copyBtn = document.getElementById("btnCopyPrevDay");
    if (copyBtn) {
      copyBtn.addEventListener("click", (e) => {
        const ok = confirm("¿Copiar todas las salidas del día anterior a esta fecha? Si ya existen algunas, se omiten duplicados.");
        if (!ok) e.preventDefault();
      });
    }
  })();
</script>

{% endblock %}
