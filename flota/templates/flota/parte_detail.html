{% extends "base.html" %}

{% block title %}Parte {{ p.id }} | Flota{% endblock %}
{% block page_title %}Parte diario #{{ p.id }}{% endblock %}
{% block page_subtitle %}Unidad {{ p.colectivo.interno }} - {{ p.get_tipo_display }} - {{ p.get_estado_display }}{% endblock %}

{% block content %}
<div class="space-y-4">

  <!-- Estilos de impresión (no requiere rebuild de Tailwind) -->
  <style media="print">
    /* Ocultar navegación / controles */
    aside, header, #drawer, #drawerOverlay { display: none !important; }
    .no-print { display: none !important; }
    body { background: #fff !important; color: #000 !important; }
    main { overflow: visible !important; }
    .ti-card { box-shadow: none !important; }
    a { color: #000 !important; text-decoration: none !important; }
  </style>

  <!-- Encabezado solo para impresión -->
  <section class="hidden print:block">
    <div class="text-lg font-semibold">Pañol ERP · Parte diario</div>
    <div class="text-sm">Referencia: PD-{{ p.id }} · Impreso: {% now "d/m/Y H:i" %}</div>
    <hr class="my-3" />
  </section>

  <section class="ti-card p-4">

    <div class="no-print flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="text-xs ti-subtitle">Referencia: <span class="font-semibold">PD-{{ p.id }}</span> · Usala para cruzar con inventario, reportes y auditoría.</div>
      <div class="flex gap-2">
        <button type="button" class="ti-btn" onclick="window.print()">Imprimir</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-3 text-sm">
      <div>
        <div class="text-xs ti-subtitle">Fecha</div>
        <div class="font-semibold tabular-nums">{{ p.fecha_evento|date:"d/m/Y H:i" }}</div>
      </div>
      <div>
        <div class="text-xs ti-subtitle">Unidad</div>
        <div class="font-semibold tabular-nums">{{ p.colectivo.interno }}</div>
        <div class="text-xs ti-subtitle">{{ p.colectivo.dominio|default:"—" }}</div>
      </div>
      <div>
        <div class="text-xs ti-subtitle">Severidad</div>
        <div class="font-semibold">{{ p.get_severidad_display }}</div>
      </div>
      <div>
        <div class="text-xs ti-subtitle">Odómetro</div>
        <div class="font-semibold tabular-nums">{% if p.odometro_km %}{{ p.odometro_km }} km{% else %}—{% endif %}</div>
      </div>
    </div>

    <div class="mt-3">
      <div class="text-xs ti-subtitle">Descripción</div>
      <div class="mt-1 text-sm whitespace-pre-line">{{ p.descripcion }}</div>
    </div>

    {% if p.observaciones %}
      <div class="mt-3">
        <div class="text-xs ti-subtitle">Observaciones</div>
        <div class="mt-1 text-sm whitespace-pre-line">{{ p.observaciones }}</div>
      </div>
    {% endif %}

    {% if p.tipo == "MANTENIMIENTO" %}
      <div class="mt-4 ti-card p-3">
        <div class="text-sm font-semibold">Detalle de mantenimiento</div>
        <div class="mt-2 grid grid-cols-1 lg:grid-cols-3 gap-2 text-sm">
          <div>
            <span class="text-xs ti-subtitle">Acción</span>
            <div class="font-semibold">{{ p.get_accion_mantenimiento_display }}</div>
          </div>
          <div>
            <span class="text-xs ti-subtitle">Km</span>
            <div class="font-semibold tabular-nums">{% if p.km_mantenimiento %}{{ p.km_mantenimiento }}{% else %}—{% endif %}</div>
          </div>
          <div>
            <span class="text-xs ti-subtitle">Matafuego vto</span>
            <div class="font-semibold">{% if p.matafuego_vto_nuevo %}{{ p.matafuego_vto_nuevo|date:"d/m/Y" }}{% else %}—{% endif %}</div>
          </div>
        </div>
      </div>
    {% endif %}

    {% if p.tipo == "AUXILIO" %}
      <div class="mt-4 ti-card p-3">
        <div class="text-sm font-semibold">Auxilio</div>
        <div class="mt-2 grid grid-cols-1 lg:grid-cols-3 gap-2 text-sm">
          <div>
            <span class="text-xs ti-subtitle">Inicio</span>
            <div class="font-semibold tabular-nums">{% if p.auxilio_inicio %}{{ p.auxilio_inicio|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
          </div>
          <div>
            <span class="text-xs ti-subtitle">Fin</span>
            <div class="font-semibold tabular-nums">{% if p.auxilio_fin %}{{ p.auxilio_fin|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
          </div>
          <div>
            <span class="text-xs ti-subtitle">Duración</span>
            <div class="font-semibold tabular-nums">{% if p.duracion_auxilio_min is not None %}{{ p.duracion_auxilio_min }} min{% else %}—{% endif %}</div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="no-print mt-4 flex flex-wrap gap-2">
      <a class="ti-btn" href="{% url 'flota:colectivo_report' p.colectivo.id %}">Volver a informe</a>
      <a class="ti-btn" href="{% url 'flota:parte_list' %}">Ver lista</a>

      <a class="ti-btn-primary"
         href="{% url 'inventario:movimiento_create' %}?tipo=EGRESO&colectivo={{ p.colectivo.id }}&force=1&ref=PD-{{ p.id }}&next={{ request.get_full_path|urlencode }}">
        Registrar movimiento (inventario)
      </a>
    </div>
  </section>

  <section class="ti-card p-4">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold">Adjuntos</div>
        <div class="text-xs ti-subtitle">Fotos JPG </div>
      </div>
    </div>

    <div class="no-print">
      <form class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-2 items-end"
            method="post"
            enctype="multipart/form-data"
            action="{% url 'flota:parte_adjunto_add' p.id %}">
        {% csrf_token %}
        <div class="lg:col-span-2">
          <label class="text-xs ti-subtitle">Archivo</label>
          <input class="ti-input w-full" type="file" name="archivo" accept="image/*,.pdf">
        </div>
        <div>
          <label class="text-xs ti-subtitle">Descripción</label>
          <input class="ti-input w-full" type="text" name="descripcion" placeholder="Ej: Foto / boleta / comprobante">
        </div>
        <div class="lg:col-span-3">
          <button class="ti-btn-primary" type="submit">Subir adjunto</button>
          <div class="text-xs ti-subtitle mt-2">Consejo: una foto clara y una descripción corta (1 línea).</div>
        </div>
      </form>
    </div>

    <div class="mt-4 overflow-x-auto">
      <table class="ti-table">
        <thead class="ti-thead">
          <tr>
            <th class="ti-th">Fecha</th>
            <th class="ti-th">Descripción</th>
            <th class="ti-th">Archivo</th>
            <th class="ti-th text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for a in p.adjuntos.all %}
            <tr class="ti-tr">
              <td class="ti-td text-xs tabular-nums">{{ a.created_at|date:"d/m/Y H:i" }}</td>
              <td class="ti-td text-xs">{{ a.descripcion|default:"—" }}</td>
              <td class="ti-td text-xs">
                <a class="ti-link" href="{{ a.archivo.url }}" target="_blank">{{ a.archivo.name }}</a>
              </td>
              <td class="ti-td text-right">
                <div class="no-print">
                  <form method="post" action="{% url 'flota:parte_adjunto_delete' p.id a.id %}">
                    {% csrf_token %}
                    <button class="ti-btn" type="submit">Eliminar</button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr class="ti-tr">
              <td class="ti-td" colspan="4"><div class="text-xs ti-subtitle">Sin adjuntos.</div></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </section>

</div>
{% endblock %}