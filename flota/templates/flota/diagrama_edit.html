{% extends "base.html" %}
{% load static %}

{% block title %}Editar diagrama | Flota{% endblock %}
{% block page_title %}Editar diagrama{% endblock %}
{% block page_subtitle %}Reemplazos rápidos (unidad + chofer){% endblock %}

{% block content %}

<div class="ti-card p-4 space-y-3">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <div class="text-sm ti-subtitle">{{ day|date:"d/m/Y" }}</div>
      <div class="text-xs ti-subtitle mt-1">
        En esta pantalla se cambian solo la unidad y el chofer. Para editar horarios, recorridos, regresos o viajes especiales, usá Horarios → Editar.
      </div>
    </div>

    <div class="flex items-center gap-2">
      <a class="ti-btn" href="{% url 'flota:salida_list' %}?fecha={{ day|date:'Y-m-d' }}">Volver a Horarios</a>
      <a class="ti-btn" href="{% url 'flota:salida_diagrama_print' %}?fecha={{ day|date:'Y-m-d' }}">Imprimir</a>
    </div>
  </div>
</div>

{% if not formset.forms %}
  <div class="ti-card p-4">
    <div class="text-sm font-semibold">No hay salidas para este día.</div>
    <div class="text-xs ti-subtitle mt-1">Para operar con horarios fijos, primero generá el diagrama del día.</div>

    {% if perms.flota.add_salidaprogramada %}
      <div class="mt-3 flex flex-wrap gap-2">
        <form method="post" action="{% url 'flota:salida_generar_plantilla' %}" class="inline">
          {% csrf_token %}
          <input type="hidden" name="fecha" value="{{ day|date:'Y-m-d' }}">
          <input type="hidden" name="modo" value="normal">
          <button type="submit" class="ti-btn-primary" data-ti-confirm="¿Generar el diagrama base para esta fecha usando una plantilla existente? Si ya existen salidas, se omiten duplicados.">Generar base</button>
        </form>

        <form method="post" action="{% url 'flota:salida_copy_prev_day' %}" class="inline">
          {% csrf_token %}
          <input type="hidden" name="fecha" value="{{ day|date:'Y-m-d' }}">
          <button type="submit" class="ti-btn" data-ti-confirm="¿Copiar todas las salidas del día anterior a esta fecha? Si ya existen algunas, se omiten duplicados.">Copiar día anterior</button>
        </form>
      </div>
    {% endif %}
  </div>
{% endif %}

<form method="post" class="ti-card p-0 overflow-hidden">
  {% csrf_token %}
  {{ formset.management_form }}

  <table class="ti-table">
    <thead class="ti-thead">
      <tr>
        <th class="ti-th">Hora</th>
        <th class="ti-th">Sección / Etiqueta</th>
        <th class="ti-th">Regreso</th>
        <th class="ti-th">Recorrido</th>
        <th class="ti-th">Unidad</th>
        <th class="ti-th">Chofer</th>
        <th class="ti-th">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for form in formset.forms %}
        {% with obj=form.instance %}
          <tr class="ti-tr">
            <td class="ti-td font-semibold tabular-nums">{{ obj.salida_programada|date:"H:i" }}</td>
            <td class="ti-td">
              <div class="font-semibold">
                {% if obj.tipo == "ESPECIAL" %}Especial{% else %}Fijo{% endif %}
              </div>
              <div class="text-xs ti-subtitle">{{ obj.seccion }}</div>
              <div class="text-xs ti-subtitle">{{ obj.salida_label }}</div>
            </td>
            <td class="ti-td">{{ obj.regreso|default:"—" }}</td>
            <td class="ti-td">{{ obj.recorrido|default:"—" }}</td>
            <td class="ti-td">{{ form.colectivo }}</td>
            <td class="ti-td">
              {{ form.chofer }}
              <datalist id="dl_choferes">
                {% for v in datalist_choferes %}
                  <option value="{{ v }}"></option>
                {% endfor %}
              </datalist>
            </td>
            <td class="ti-td">
              <div class="flex flex-wrap gap-2">
                {% if obj.parte_pk %}
                  <a class="ti-btn" href="{% url 'flota:parte_detail' obj.parte_pk %}" target="_blank" rel="noopener">Revisar parte</a>
                {% else %}
                  <span class="ti-badge-ok">OK</span>
                {% endif %}
                {% if obj.tipo == "ESPECIAL" %}
                  <a class="ti-btn" href="{% url 'flota:salida_update' obj.pk %}?fecha={{ day|date:'Y-m-d' }}">Editar completo</a>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endwith %}
      {% empty %}
      {% endfor %}
    </tbody>
  </table>

  <div class="p-4 flex items-center justify-end gap-2 border-t border-slate-200 dark:border-slate-800">
    <button type="submit" class="ti-btn-primary">Guardar cambios</button>
  </div>
</form>

{% endblock %}
