{% extends "base.html" %}
{% load static %}

{% block title %}Editar diagrama | Flota{% endblock %}
{% block page_title %}Editar diagrama{% endblock %}
{% block page_subtitle %}Reemplazos rápidos (unidad + chofer){% endblock %}

{% block content %}
<div class="space-y-4">

  <div class="ti-card p-4">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
      <div>
        <div class="text-sm ti-subtitle">{{ day|date:"d/m/Y" }}</div>
        <div class="mt-1 text-sm">
          En esta pantalla se cambian <span class="font-semibold">solo</span> la <span class="font-semibold">unidad</span> y el <span class="font-semibold">chofer</span>.
          Para editar horarios, recorridos, regresos o viajes especiales, usá <span class="font-semibold">Horarios → Editar</span>.
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="ti-btn" href="{% url 'flota:salida_list' %}?fecha={{ day|date:'Y-m-d' }}">Volver a Horarios</a>
        <a class="ti-btn" href="{% url 'flota:salida_diagrama_print' %}?fecha={{ day|date:'Y-m-d' }}" target="_blank" rel="noopener">Imprimir</a>
      </div>
    </div>
  </div>

  <form method="post" class="space-y-4">
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="ti-card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs ti-subtitle">
              <th class="text-left px-3 py-3 w-[90px]">Hora</th>
              <th class="text-left px-3 py-3 min-w-[240px]">Sección / Etiqueta</th>
              <th class="text-left px-3 py-3 min-w-[140px]">Regreso</th>
              <th class="text-left px-3 py-3 min-w-[220px]">Recorrido</th>
              <th class="text-left px-3 py-3 min-w-[220px]">Unidad</th>
              <th class="text-left px-3 py-3 min-w-[220px]">Chofer</th>
              <th class="text-left px-3 py-3 w-[170px]">Acciones</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-slate-800/60">
            {% for form in formset.forms %}
              {% with obj=form.instance %}
              <tr>
                <td class="px-3 py-3 align-top whitespace-nowrap">
                  <div class="font-semibold">{{ obj.salida_programada|date:"H:i" }}</div>
                  {% if obj.tipo == "ESPECIAL" %}
                    <div class="mt-1 inline-flex ti-badge-warning">Especial</div>
                  {% else %}
                    <div class="mt-1 inline-flex ti-badge-muted">Fijo</div>
                  {% endif %}
                </td>

                <td class="px-3 py-3 align-top">
                  <div class="text-xs ti-subtitle">{{ obj.seccion }}</div>
                  <div class="font-semibold">{{ obj.salida_label }}</div>
                </td>

                <td class="px-3 py-3 align-top whitespace-nowrap">
                  {% if obj.regreso %}
                    <div class="font-semibold">{{ obj.regreso }}</div>
                  {% else %}
                    <div class="ti-subtitle">—</div>
                  {% endif %}
                </td>

                <td class="px-3 py-3 align-top">
                  {% if obj.recorrido %}
                    <div class="font-semibold">{{ obj.recorrido }}</div>
                  {% else %}
                    <div class="ti-subtitle">—</div>
                  {% endif %}
                </td>

                <td class="px-3 py-3 align-top">
                  {{ form.colectivo }}
                </td>

                <td class="px-3 py-3 align-top">
                  {{ form.chofer }}
                </td>

                <td class="px-3 py-3 align-top whitespace-nowrap">
                  <div class="flex flex-wrap gap-2 items-center">
                    {% if obj.parte_pk %}
                      <a class="ti-btn" href="{% url 'flota:parte_detail' obj.parte_pk %}" target="_blank" rel="noopener">Revisar parte</a>
                    {% else %}
                      <span class="ti-badge-success">OK</span>
                    {% endif %}

                    {% if obj.tipo == "ESPECIAL" %}
                      <a class="ti-btn" href="{% url 'flota:salida_update' obj.pk %}?fecha={{ day|date:'Y-m-d' }}">Editar completo</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="7" class="px-3 py-10 text-center ti-subtitle">
                  No hay salidas para este día.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="flex justify-end">
      <button class="ti-btn-primary px-5 py-3" type="submit">Guardar cambios</button>
    </div>

    <datalist id="dl_choferes">
      {% for v in datalist_choferes %}
        <option value="{{ v }}"></option>
      {% endfor %}
    </datalist>

  </form>

</div>
{% endblock %}
